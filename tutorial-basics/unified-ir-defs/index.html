<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tutorial-basics/unified-ir-defs" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Introduction To Unified IR | Unified IR</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://unified-ir.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://unified-ir.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://unified-ir.github.io/tutorial-basics/unified-ir-defs"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Introduction To Unified IR | Unified IR"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://unified-ir.github.io/tutorial-basics/unified-ir-defs"><link data-rh="true" rel="alternate" href="https://unified-ir.github.io/tutorial-basics/unified-ir-defs" hreflang="zh"><link data-rh="true" rel="alternate" href="https://unified-ir.github.io/tutorial-basics/unified-ir-defs" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.310e4b26.css">
<script src="/assets/js/runtime~main.3bcc1fb6.js" defer="defer"></script>
<script src="/assets/js/main.13d54818.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Unified IR</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Tutorial</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/unified-ir" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Unified IR</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/category/unified-ir---basics">Unified IR - Basics</a><button aria-label="折叠侧边栏分类 &#x27;Unified IR - Basics&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/tutorial-basics/unified-ir-defs">Introduction To Unified IR</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/category/unified-ir---basics"><span itemprop="name">Unified IR - Basics</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Introduction To Unified IR</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Introduction To Unified IR</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接">​</a></h2>
<p><strong>Unified IR</strong> 是一个描述张量程序的统一中间表示，旨在为人工智能应用提供跨平台的统一编译优化。每个张量程序都对应于 <strong>Unified IR</strong> 中的一个 <strong>Kernel Graph</strong>，描述了不同的设备算子在张量程序中的数据 依赖关系；<strong>Kernel Graph</strong> 中部分节点为自定义算子，表示为一个 <strong>iGraph</strong>，这是一个对描述算子实现的指令级中间表示。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kernel-graph">Kernel Graph<a href="#kernel-graph" class="hash-link" aria-label="Kernel Graph的直接链接" title="Kernel Graph的直接链接">​</a></h2>
<p>在 <strong>Unified IR</strong> 中，<strong>Kernel Graph</strong> 用于描述一个张量程序，其中的每个节点表示一个在目标硬件平台上执行的算子，每条边表示在不同算子之间共享的张量。所有的张量都存储在设备的DRAM中，这是因为不同的算子无法通过寄存器文件或者SRAM共享数据。每个节点所表示的算子可以是对应硬件预定义的算子，如矩阵乘法和卷积，也可以是由 <strong>iGraph</strong> 描述的自定义算子，<strong>iGraph</strong> 允许我们在 <strong>Kernel Graph</strong> 层级上做算子融合等算子间（inter-operator）优化。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="igraph">iGraph<a href="#igraph" class="hash-link" aria-label="iGraph的直接链接" title="iGraph的直接链接">​</a></h2>
<p><strong>iGraph</strong> 从硬件指令的角度描述了算子的实现，它的形式是一个数据流图，描述了数据在不同内存层级间的移动和硬件指令对数据的处理。图中的每个节点为 <strong>iOp</strong>，表示在硬件的最小并行单元上的一条硬件指令或是一个指令序列，每条边是一个 <strong>iSlice</strong>，表示数据切片，是上述的 <strong>iOp</strong> 所作用的基本单元。<strong>iGraph</strong> 还包含硬件并行架构信息和对算子实现并行方式的描述。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-model">Hardware Model<a href="#hardware-model" class="hash-link" aria-label="Hardware Model的直接链接" title="Hardware Model的直接链接">​</a></h3>
<p>考虑到AI加速硬  件内在的相似性，<strong>Unified IR</strong> 提出了一套高层次的对硬件并行架构的建模，从而可以用一套统一的方式描述不同的硬件的特性。</p>
<p>我们定义 <strong>最小并行单元</strong> 为目标硬件中可以独立执行的最小单元，这在不同的硬件中有不同的含义，在NVIDIA系列的GPU上对应于SMSP（可以独立的调度warp），而在Ascend 910系列芯片中则对应于一个AI Core。在部分硬件中，多个最小并行单元可以组成一组协同计算，之间可以通过SRAM来进行通信，我们称这样的一组最小并行单元为 <strong>并行组</strong>。例如在CUDA编程中，一个线程块包含多个Warp，它们都在同一个SM上执行，彼此之间可以进行同步和通过共享内存同步数据。而一个AI加速硬件包含多个上述的 <strong>并行组</strong>。</p>
<p>对内存层级也可以做类似的划分，按照访问速度从高到低可以分为 <strong>REG</strong>、<strong>SRAM</strong> 和 <strong>DRAM</strong>。<strong>REG</strong> 层级的内存由每个最小并行单元独占，访问速度最快；<strong>SRAM</strong> 层级的内存则可以在不同的并行组之间共享，访问速度次之；<strong>DRAM</strong> 在不同的算子之间共享，访问速度最慢。</p>
<p>因此，根据上述的 “硬件 -&gt; 并行组 -&gt; 最小并行单元” 的抽象，我们可以用二元组 (numGroup, numUnit) 来描述硬件的并行架构，分别表示一个硬件中有多少个并行组，一个并行组中有多少个最小并行单元。由于CUDA的编程接口对底层的硬件架构做了进一步的抽象，一个核函数的grid size和block size均可变，我们这套模型在描述CUDA算子时需要做一些微妙的调整：我们令numGroup对应于算子实现中的grid size，而numUnit对应于线程块中的Warp数量。此外，Ascend 910 系列芯片的AI Core之间不能进行通信，因此就不存在上述的 <strong>并行组</strong> 层级，这对应于numUnit为1的退化情况。</p>
<p>类似的，我们也可以将具体硬件的内存层级按照其和并行架构的关系映射到上述的 “REG -&gt; SRAM -&gt; DRAM” 层级上。对于NVIDIA的GPU来说，寄存器文件对应 <strong>REG</strong>，共享内存对应 <strong>SRAM</strong>，全局内存对应 <strong>DRAM</strong>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parallel-description">Parallel Description<a href="#parallel-description" class="hash-link" aria-label="Parallel Description的直接链接" title="Parallel Description的直接链接">​</a></h3>
<p><strong>iGraph</strong> 中的并行方式描述包含两个维度，分别是并行维度和循环维度，用元组 (numParallel, numLoop) 表示。前者表示算子实现中将计算任务在 numParallel 个最小并行单元中并行执行，并为每一个最小并行单元分配一个取值于 [0, numParallel) 的和硬件并行架构相容的并行编号。例如，对于硬件架构由 (108, 4) 来描述的硬件，其 numParallel = $108 \times 4$ = $432$，第1个并行组中的4个最小并行单元的编号为0、1、2、3，第2个并行组为4、5、6、7，以此类推。编号用于为不同的单元分配计算任务，其相容性让我们可以在并行组的层级上对数据的复用进行优化。后者表示了每个并行处理单元内会做长度为numLoop的串行循环，执行由 <strong>iGraph</strong> 内的 <strong>iOp</strong> 所定义的指令序列。其语义如下：</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> parallel_id </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numParallel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Parallel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> loop_id </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numLoop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Series</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loopBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parallel_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> loop_id</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="islice">iSlice<a href="#islice" class="hash-link" aria-label="iSlice的直接链接" title="iSlice的直接链接">​</a></h3>
<p><strong>iSlice</strong> 用于表示每个并行处理单元在每个循环中所需要处理的数据切片，描述了数据如何在不同的并行单元和不同的循环上进行划分。所有 <strong>iSlice</strong> 都基于一个 <strong>iPointer</strong>，<strong>iPointer</strong> 表示在某内存层级上的一块连续内存，包含所在层级、名称、数据类型和长度等属性。其中，<code>dram</code> 上的iPointer在全局唯一，<code>sram</code> 上的iPointer在每个并行组内唯一，而 <code>reg</code> 上的iPointer则为每个最小并行单元独占。<strong>iSlice</strong> 则表示在它所基于的 <strong>iPointer</strong> 所指向的连续内存上的一个二维切片，由一组连续的内存片段组成，具有属性 <code>Shape</code>、<code>Stride</code> 和 <code>Offset</code>。<code>Shape</code> 是一个二元组，表示该内存切片的形状，<code>Stride</code> 也是一个二元组，表示在不同维度上的步长，<code>Offset</code> 则是一个关于 <code>parallel_id</code> 和 <code>loop_id</code> 的仿射函数，用于表示每一个最小并行单元在每个循环中所处理的内存切片的的首地址相对于其所基于的iPointer的偏移，用于表示输入输出数据和中间变量在不同并行单元和循环上的划分。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iPointer ::= iPointer(ID, Hierarchy, DType, Size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ID ::= Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hierarchy ::= reg | sram | dram</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DType ::= fp64 | fp32 | fp16 ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Size ::= Int</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iSlice ::= iSlice(iPointer, Offset, Shape, Stride)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Offset ::= Affine Function of (parallel_id, loop_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shape ::= (Int, Int)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Stride ::= (Int, Int)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>举个例子，假设一个 <strong>iGraph</strong> 被用于表示一个张量加法算子，输入张量的形状为<code>(8， 1024)</code>，并且 <code>(numParallel, numLoop) = (64, 2)</code>，则这个输入张量可以用一个 <strong>iPointer</strong> 描述：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">a </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们在各个最小并行单元间的各个循环间均匀分配所需要处理的输入数据，则数据的划分可以用 <strong>iSlice</strong> 描述：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aSlice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iSlice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4096</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lid </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>假设我们在算子实现中，需要先将数据读入寄存器中再进行计算，则可以按照如下描述这些寄存器，可以注意到寄存器是每个最小并行单元所独占的，所以 <code>b</code> 位于 <code>reg</code> 上，并且大小为64。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">b </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bSlice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="iop">iOp<a href="#iop" class="hash-link" aria-label="iOp的直接链接" title="iOp的直接链接">​</a></h3>
<p><strong>iOp</strong> 是对硬件指令的抽象，其输入输出都是上面定义的 <strong>iSlice</strong>，表示在内存切片上的硬件指令操作。作为对硬件指令的抽象，一个 <strong>iOp</strong> 通常可以在一个最小并行单元上  由一条硬件指令或者一个硬件指令序列完成。<strong>iOp</strong> 分为访存iOp和计算iOp，分别用来表示访存操作和计算。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="访存iop">访存iOp<a href="#访存iop" class="hash-link" aria-label="访存iOp的直接链接" title="访存iOp的直接链接">​</a></h4>
<p>访存iOp分为两种，一种是移动（Move），另一种是同步（Sync）。</p>
<p>移动iOp表示在不同的内存层级间移动内存切片，或者在同一内存层级内对内存切片的布局进行改变，对应硬件指令上的内存相关指令，其语义是将位于 <code>from</code> 上的内存切片 <code>s1</code> 搬运到位于 <code>to</code> 上的内存切片 <code>t1</code> 上，并且搬运的数据类型为 <code>dtype</code>。实际上，由于 <code>s1</code> 和 <code>t1</code> 作为内存切片不仅包含其基于的指针、地址偏移、形状和步长等信息，也包含了该内存切片所在层级和内部的数据类型，因此 <code>move</code> 指令中的属性均可以从输入输出中推导出来，这里将其显式定义出来是为了易读性。如无特殊说明，下面介绍的其他 <strong>iOp</strong> 定义也遵循这一约定。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">move</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reg</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reg</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bf16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">move</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dram</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">move</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>同步iOp则表示需要在某个内存层级上对相应的并行结构做同步，从而保证数据依赖的正确性。可以注意到 <code>sync</code> 指令要求 <code>iPointer(t1) = iPointer(s1)</code>，这是因为只有当算子实现中写入和读出的内存是重叠的时候才需要同步。例如，<code>s1</code> 和 <code>t1</code> 都对应于同一个 <code>dram</code> 上的iPointer，且有相同的形状和步长，但是二者的地址偏移不同，这就意味着一个最小并行单元所读取的切片可能是由别的单元写入的，因此需要进行同步才能保证数据依赖的正确性。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reg</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">iPointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sram t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="计算iop">计算iOp<a href="#计算iop" class="hash-link" aria-label="计算iOp的直接链接" title="计算iOp的直接链接">​</a></h4>
<p>计算iOp有几种类型，有 <code>unary</code>、<code>binary</code>、<code>broadcast</code>、<code>reduce</code> 和 <code>identity</code>。<code>unary</code> 为单目运算，语法如下，其中 <code>name</code> 表示运算类型，<code>dtype</code> 表示数据类型，<code>params</code> 为可选参数，用于 <code>muls</code>、<code>leaky_relu</code> 等指令。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">unary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">muls</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">divs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relu</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bf16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">muls</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2.0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>binary</code> 为双目运算，其定义和 <code>unary</code> 类似。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">binary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">div</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bf16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>broadcast</code> 和 <code>reduce</code> 表示广播和规约iOp，其中 <code>dtype</code> 表示数据类型，<code>axis</code> 表示在进行规约或者广播的轴。而 <code>scope</code> 表示在什么范围内进行规约或者广播，其中 <code>unit</code> 表示在每个最小并行单元内，而 <code>group</code> 表示在同一并行组内的多个最小并行单元之间，<code>op</code> 表示用于规约的计算类型。对于 <code>group</code> 层级上的规约或者广播涉及到不同并行单元，因此需要在 <code>sram</code> 上通信，所以需要在 <code>params</code> 中指定一个位于 <code>sram</code> 上的iSlice作为buffer来辅助，另外参数groupSize指定的进行广播或者规约的组的大小，需要满足 <code>numUnit % groupSize == 0</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">axis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">axis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bf16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 1), Shape(t1) = (4, 128)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (1, 128), Shape(t1) = (4, 128)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">buffer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupSize</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 1), Shape(t1) = (4, 128), numUnit = 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">buffer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupSize</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (1, 128), Shape(t1) = (4, 128), numUnit = 8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于 <code>group</code> 层级上的规约，其最终规约的结果会保存在 <code>parallel_id % groupSize == 0</code> 的最小并行单元上；而对于 <code>group</code> 层级上的广 播，其广播的值来自 <code>parallel_id % groupSize == 0</code> 的最小并行单元。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reduce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">axis</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">params</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">op </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mul</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">axis </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dtype </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bf16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp8</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scope </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// examples</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reduce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 128), Shape(t1) = (4, 1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reduce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 128), Shape(t1) = (1, 128)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reduce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">buffer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupSize</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 128), Shape(t1) = (1, 128), numUnit = 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reduce</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">col</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fp32 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">buffer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> groupSize</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(s1) = (4, 128), Shape(t1) = (1, 128), numUnit = 8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了以上这些iOp之外，还有一类不表示具体计算但是对Unified IR的表达性十分重要的iOp，称为 <code>identity</code>。顾名思义，它表示输入输出的两组iSlice在物理内存上是同一块，可以用于在iGraph中表达Reshape、Split、Concat等逻辑。<code>identity</code> 指令要求输入输出的 <code>iSlice</code> 表示同一块的物理内存。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">identity </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ts</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">ss</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">identity t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(t1) = (4, 64), Shape(s1) = (2, 128)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">identity t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(t1) = (4, 64), Shape(s1) = Shape(s2) = (4, 32)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">identity </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1 </span><span class="token comment" style="color:#999988;font-style:italic">// Shape(t1) = Shape(t2) = (4, 32), Shape(s1) = (4, 64)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/category/unified-ir---basics"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Unified IR - Basics</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#kernel-graph" class="table-of-contents__link toc-highlight">Kernel Graph</a></li><li><a href="#igraph" class="table-of-contents__link toc-highlight">iGraph</a><ul><li><a href="#hardware-model" class="table-of-contents__link toc-highlight">Hardware Model</a></li><li><a href="#parallel-description" class="table-of-contents__link toc-highlight">Parallel Description</a></li><li><a href="#islice" class="table-of-contents__link toc-highlight">iSlice</a></li><li><a href="#iop" class="table-of-contents__link toc-highlight">iOp</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/unified-ir" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 PACMAN Group. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>